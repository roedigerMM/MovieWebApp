{% extends "base.html" %}

{% block content %}
  <section class="page-header">
    <div>
      <a class="text-link" href="{{ url_for('index') }}">Back to users</a>
      <h1>{{ user.name }}'s Favorites</h1>
      <p class="subtitle">Search by title and add the right movie.</p>
    </div>
    <form class="inline-form" action="{{ url_for('add_user_movie', user_id=user.id) }}" method="post">
      <label class="sr-only" for="title">Title</label>
      <input id="title" name="title" type="text" value="{{ search_title or '' }}" placeholder="Add a movie title" required />
      <button class="btn primary" type="submit">Search</button>
    </form>
  </section>

  {% if error %}
    <p class="alert">{{ error }}</p>
  {% endif %}

  {% if search_results %}
    <section class="panel">
      <h2>Choose a Match</h2>
      <form class="result-grid" action="{{ url_for('add_user_movie', user_id=user.id) }}" method="post">
        <input type="hidden" name="title" value="{{ search_title }}" />
        {% for result in search_results %}
          <label class="result-card">
            <input type="radio" name="imdb_id" value="{{ result.imdb_id }}" required />
            <span class="result-title">{{ result.title }}</span>
            <span class="result-meta">{{ result.year }}</span>
            {% if result.poster_url and result.poster_url != "N/A" %}
              <img src="{{ result.poster_url }}" alt="Poster for {{ result.title }}" />
            {% endif %}
          </label>
        {% endfor %}
        <button class="btn primary" type="submit">Use Selected Movie</button>
      </form>
    </section>
  {% endif %}

  <section class="panel">
    <h2>Movies</h2>
    {% if movies %}
      <div class="movie-grid">
        {% for movie in movies %}
          <article class="movie-card">
            <img src="{{ movie.poster_url }}" alt="Poster for {{ movie.name }}" />
            <div class="movie-info">
              <h3>{{ movie.name }}</h3>
              <p class="muted">{{ movie.year }} Â· {{ movie.director }}</p>
              <div class="movie-actions">
                <details class="update-panel">
                  <summary class="btn ghost action-btn">Update Title</summary>
                  <form class="inline-form" action="{{ url_for('update_user_movie', user_id=user.id, movie_id=movie.id) }}" method="post">
                    <label class="sr-only" for="title-{{ movie.id }}">Update Title</label>
                    <input id="title-{{ movie.id }}" name="title" type="text" value="{{ movie.name }}" required />
                    <button class="btn ghost" type="submit">Save</button>
                  </form>
                </details>
                <form action="{{ url_for('delete_user_movie', user_id=user.id, movie_id=movie.id) }}" method="post">
                  <button class="btn danger action-btn" type="submit">Delete</button>
                </form>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="empty-state">No movies yet. Add one above.</p>
    {% endif %}
  </section>
{% endblock %}
